# Redis

## 慢查询

1. 生命周期

- 慢查询发生在第 3 阶段
- 客户端超时不一定慢查询，但慢查询是客户端超过的一个可能因素

```lua
                       |               Redis
      1.发送命令         |               2. 排队
      - - - - - >       |
client                  |  cmd5, cmd4, cmd3, cmd2, cmd1
                        |                            |
       4.返回结果         |                          3. 执行命令
       < - - - - -
```

2. 两个配置

- slowlog-max-len

  > 先进先出队列
  > 固定长度
  > 保存在内存内

- slowlog-log-slower-than

  > 慢查询阈值（单位：微妙）
  > = 0,记录所有命令
  > < 0, 不记录命令

- 配置方法

  > 1. 默认值：config get slowlog-max-len=128; config get slowlog-log-slower-than = 10000;
  > 2. 修改配置文件重启

- 三个命令

> 1. slowlog get [n]: 获取慢查询队列
> 2. slowlog len: 获取慢查询队列长度
> 3. slowlog reset: 清空慢查询队列

- 运维经验

> 1. slowlog-max-len 不要设置过大，默认 10ms,通常设置 1ms
> 2. slowlog-log-slower-than 不要设置过小，通常设置 1000 左右。
> 3. 理解命令生命周期
> 4. 定期持久化慢查询

## pipeline

- 什么是流水线？

1. 1 次网络命令通信
   > 1 次时间 = 1 次网络时间 + 1 次命令时间
2. 流水线：1）将一批命令进行打包传递给 server 2）server 计算处理 n 次 3）server 将结果按顺序进行返回给 client 端。

   > 1 次 pipeline(n 条命令) = 1 次网络时间 + n 次命令时间

3. 注意：
   1） Redis 的命令时间是 微妙级别的。
   2） pipeline 每次条数要控制（网络）。

- 客户端如何实现？

```java
Jedis jedis = new Jedis("127.0.0.1", 6379);
for(int i = 0; i < 100; i++) {
    Pipeline pipeline = jedis.pipelined();
    for(int j = i*100; j < (i + 1)*100; j++) {
        pipeline.hset("hashkey:" + j, "field" + j, "value" + j);
    }
    pipeline.syncAndReturnAll();
}
```

- 与原生操作对比
- 使用建议

1. 注意每次 pipeline 携带数据量
2. pipeline 每次智能作用在一个 Redis 节点上
3. M 操作与 pipeline 区别

## 发布订阅

- 角色

1. 发布者(publisher)
2. 订阅者(subscriber)
3. 频道(channel)

- 模型

```lua
                                       Redis server

发布者    - - 发布消息 - - >       vrs 频道        Pgc 频道
                         |- - - ->|   | <- - - - - |  |
                       订阅者      订阅者          订阅者 [可能订阅多个频道]
                       redis-cli  redis-cli       redis-cli
redis-cli
```

- API

1. publish

```sh
# 向 sohu:tv 发送 "hello world" 消息， 返回 订阅的个数
publish sohu:tv   "hello world"
```

2. subscribe

```sh
subscribe shhu:tv
```

3. unsubscribe

4. 其他 API
   > 1. psubscribe # 订阅模式
   > 2. punsubscribe # 退订指定的模式
   > 3. pubsub channels # 列出至少有一个订阅者的频道
   > 4. pubsub numsub # 列出给定频道的订阅者数量

- 发布订阅与消息队列对比

消息队列，发送的消息，智能由其中一个订阅者收到。

## Bitmap

- 位图

1. `setbit key offset value`: 给位图指定索引设置值

- 独立用户统计
- 相关命令

## HyperLogLog

- 新的数据结构？
  基于 HypeLogLog 算法： 极小空间完成独立数量统计。
- 三个命令

1. `pfadd key element [element]`: 向 hyperloglog 添加元素
2. `pfcount key [key ...]`: 计算 hypeloglog 的独立总数
3. `pfmerge destkey sourcekey [sourcekey ...]`: 合并多个 hypeloglog

- 内存消耗
- 使用经验

## GEO
